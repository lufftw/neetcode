<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% if description %}
    <meta name="description" content="{{ description }}">
    {% endif %}
    <title>{{ title | default('AI Generated Markmap') }} - NeetCode Mind Maps</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; }
        .markmap { width: 100%; height: 100%; }
        .markmap > svg { width: 100%; height: 100%; }
        #topbar {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: #fff; border-bottom: 1px solid #e5e7eb;
            padding: 8px 16px; display: flex; gap: 8px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            font-size: 13px;
        }
        #topbar button {
            padding: 4px 12px; border: 1px solid #d1d5db;
            border-radius: 4px; background: #fff; cursor: pointer;
        }
        #topbar button:hover { background: #f3f4f6; }
        .markmap { margin-top: 40px; height: calc(100% - 40px); }
    </style>
    <script>
        (function () {
            // Load script only once, return Promise that resolves when loaded
            function loadScriptOnce(src) {
                return new Promise((resolve, reject) => {
                    // Check if script already exists
                    const existing = document.querySelector(`script[src="${src}"]`);
                    if (existing) {
                        // If script exists and is loaded, resolve immediately
                        if (existing.getAttribute('data-loaded') === 'true') {
                            resolve();
                            return;
                        }
                        // If script exists but not loaded, wait for it
                        existing.addEventListener('load', resolve, { once: true });
                        existing.addEventListener('error', reject, { once: true });
                        return;
                    }

                    const s = document.createElement("script");
                    s.src = src;
                    s.defer = true;
                    s.onload = function() {
                        s.setAttribute('data-loaded', 'true');
                        resolve();
                    };
                    s.onerror = () => reject(new Error("Failed to load: " + src));
                    document.head.appendChild(s);
                });
            }

            // Ensure all required markmap libraries are loaded
            async function ensureMarkmapLoaded() {
                // Ensure window.markmap exists
                if (!window.markmap) {
                    window.markmap = {};
                }

                // Load d3 first (required by markmap-view)
                if (!window.d3) {
                    await loadScriptOnce("https://cdn.jsdelivr.net/npm/d3@7");
                }
                // Load markmap-lib (provides Transformer)
                if (!window.markmap.Transformer) {
                    await loadScriptOnce("https://cdn.jsdelivr.net/npm/markmap-lib");
                }
                // Load markmap-view (provides Markmap)
                if (!window.markmap.Markmap) {
                    await loadScriptOnce("https://cdn.jsdelivr.net/npm/markmap-view");
                }
                // Load markmap-toolbar (provides Toolbar)
                if (!window.markmap.Toolbar) {
                    await loadScriptOnce("https://cdn.jsdelivr.net/npm/markmap-toolbar");
                }
            }

            // Initialize markmap visualization
            async function initMindmap() {
                const container = document.querySelector(".markmap");
                if (!container) return;

                try {
                    // Ensure libraries are loaded before initialization
                    await ensureMarkmapLoaded();

                    const mm = window.markmap;
                    if (!mm?.Transformer || !mm?.Markmap) {
                        console.warn("Markmap libraries not available");
                        return;
                    }

                    // Prevent duplicate rendering by removing existing SVG
                    container.querySelector("svg")?.remove();

                    // Initialize markmap
                    const { Transformer, Markmap } = mm;
                    const transformer = new Transformer();
                    const markdown = `{{ markdown_content | safe }}`;
                    const { root } = transformer.transform(markdown);

                    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
                    container.appendChild(svg);
                    const m = Markmap.create(svg, { color: (node) => node.payload?.color || '#f59e0b' }, root);
                    svg.mm = m;
                    m.fit();

                    // Attach toolbar if available
                    if (mm.Toolbar) {
                        const toolbar = new mm.Toolbar();
                        toolbar.attach(m);
                        setTimeout(function() {
                            document.querySelectorAll('.mm-toolbar').forEach(function(toolbar) {
                                toolbar.querySelectorAll('.mm-toolbar-item').forEach(function(item) {
                                    if ((item.title || '').toLowerCase().includes('dark')) item.remove();
                                });
                                var brand = toolbar.querySelector('.mm-toolbar-brand');
                                if (brand) {
                                    brand.innerHTML = 'ðŸŸ¡ NeetCode';
                                    brand.href = '#'; brand.onclick = function(e) { e.preventDefault(); };
                                    brand.style.fontSize = '12px'; brand.style.color = '#666';
                                }
                            });
                        }, 200);
                    }
                } catch (error) {
                    console.error("Failed to initialize markmap:", error);
                }
            }

            // Utility functions for topbar buttons
            function fitView() {
                var svg = document.querySelector('.markmap > svg');
                if (svg && svg.mm) svg.mm.fit();
            }
            function expandAll() {
                var svg = document.querySelector('.markmap > svg');
                if (svg && svg.mm) {
                    var root = svg.mm.state.data;
                    (function expand(n) {
                        n.payload = Object.assign({}, n.payload, { fold: 0 });
                        if (n.children) n.children.forEach(expand);
                    })(root);
                    svg.mm.setData(root); svg.mm.fit();
                }
            }
            function collapseAll() {
                var svg = document.querySelector('.markmap > svg');
                if (svg && svg.mm) {
                    var root = svg.mm.state.data;
                    root.children && root.children.forEach(function collapse(n) {
                        if (n.children && n.children.length) {
                            n.payload = Object.assign({}, n.payload, { fold: 1 });
                            n.children.forEach(collapse);
                        }
                    });
                    svg.mm.setData(root); svg.mm.fit();
                }
            }

            // Make functions globally available
            window.fitView = fitView;
            window.expandAll = expandAll;
            window.collapseAll = collapseAll;

            // Expose init function for re-entry (for instant navigation)
            window.__initMindmap = initMindmap;

            // 1) Full page reload - initialize on DOMContentLoaded
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", () => initMindmap(), { once: true });
            } else {
                initMindmap();
            }

            // 2) MkDocs Material instant navigation (key lifecycle hook)
            if (window.document$ && typeof window.document$.subscribe === "function") {
                window.document$.subscribe(() => initMindmap());
            }

            // 3) Back/forward cache (BFCache) restoration
            window.addEventListener("pageshow", (e) => {
                if (e.persisted) initMindmap();
            });

            // 4) Additional PJAX/Instant Navigation event support
            document.addEventListener('pjax:end', initMindmap);
            document.addEventListener('pjax:success', initMindmap);
            document.addEventListener('turbolinks:load', initMindmap);
            document.addEventListener('swup:contentReplaced', initMindmap);
            document.addEventListener('swup:pageView', initMindmap);
        })();
    </script>
</head>
<body>
    <div id="topbar">
        <button onclick="fitView()">Fit View</button>
        <button onclick="expandAll()">Expand All</button>
        <button onclick="collapseAll()">Collapse All</button>
    </div>
    <div class="markmap"></div>
</body>
</html>
